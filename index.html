<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Fukuoka Trip (Cloud Sync)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"
      }
    }
  </script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    body { -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; background-color: #f5f5f4; font-family: sans-serif; }
    .sync-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  </style>
</head>
<body>
  <div id="root">
    <div class="fixed inset-0 flex flex-col items-center justify-center bg-stone-50 z-50">
      <div class="h-10 w-10 animate-spin rounded-full border-4 border-stone-200 border-t-indigo-600"></div>
      <p class="mt-4 text-stone-400 font-bold animate-pulse text-xs">æ­£åœ¨å•Ÿå‹•é›²ç«¯åŒæ­¥ç³»çµ±...</p>
    </div>
  </div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
    import { getFirestore, doc, onSnapshot, setDoc, collection } from 'firebase/firestore';
    import { 
      MapPin, Wallet, Info, Plus, Trash2, ArrowUp, ArrowDown, Navigation, 
      Home, Plane, Utensils, ShoppingBag, Train, Camera, Edit2, Map as MapIcon, 
      List, Search, X, Check, AlertCircle, Key, Loader2, RotateCw, Footprints, 
      Car, Bus, BedDouble, Share2, Star, Cloud, CloudOff, RefreshCw
    } from 'lucide-react';

    // --- ğŸ”¥ è¨­å®šå€ ğŸ”¥ ---
    // è«‹åœ¨ä¸‹æ–¹è²¼ä¸Šä½ å¾ Firebase å–å¾—çš„ config
    const firebaseConfig = {
      apiKey: "AIzaSyBkoHeoub3Q9MsQhwIrdr9xrlPSHQ2HxfY",
      authDomain: "japantrip-e7bcd.firebaseapp.com",
      projectId: "japantrip-e7bcd",
      storageBucket: "japantrip-e7bcd.firebasestorage.app",
      messagingSenderId: "952651606596",
      appId: "1:952651606596:web:8d50f4e5d9ab47d9556a11",
      measurementId: "G-TZYLC85XGX"
    };

    const appId = "fukuoka-2026-v1"; // å›ºå®šå°ˆæ¡ˆ ID

    // åˆå§‹åŒ– Firebase
    const isCloudEnabled = !!firebaseConfig.apiKey;
    const app = isCloudEnabled ? initializeApp(firebaseConfig) : null;
    const auth = isCloudEnabled ? getAuth(app) : null;
    const db = isCloudEnabled ? getFirestore(app) : null;

    // --- Google Maps è¼‰å…¥å™¨ (Singleton) ---
    let googleMapsPromise = null;
    const loadGoogleMapsScript = (apiKey) => {
      if (!apiKey) return Promise.reject(new Error("No API Key"));
      if (window.google && window.google.maps) return Promise.resolve(window.google.maps);
      if (googleMapsPromise) return googleMapsPromise;

      googleMapsPromise = new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.id = 'google-maps-script';
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places,marker,geometry&language=zh-TW&v=weekly`;
        script.async = true;
        script.defer = true;
        script.onload = () => resolve(window.google.maps);
        script.onerror = () => { googleMapsPromise = null; reject(new Error("Google Maps Script Error")); };
        document.head.appendChild(script);
      });
      return googleMapsPromise;
    };

    const getTripDate = (dayIndex) => {
      const startDate = new Date('2026-02-26');
      const targetDate = new Date(startDate);
      targetDate.setDate(startDate.getDate() + (dayIndex - 1));
      const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][targetDate.getDay()];
      return `${targetDate.getMonth() + 1}/${targetDate.getDate()} (${dayOfWeek})`;
    };

    // --- App ä¸»ç¨‹å¼ ---
    function App() {
      const [activeTab, setActiveTab] = useState('itinerary');
      const [activeDay, setActiveDay] = useState(1);
      const [locations, setLocations] = useState([]);
      const [isEditing, setIsEditing] = useState(false);
      const [viewMode, setViewMode] = useState('list');
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('google_maps_key') || '');
      const [user, setUser] = useState(null);
      const [syncStatus, setSyncStatus] = useState('local'); // local, syncing, success

      // 1. åŒ¿åç™»å…¥ (ç‚ºäº†èˆ‡æœ‹å‹å…±ç”¨è³‡æ–™)
      useEffect(() => {
        if (!isCloudEnabled) return;
        const initAuth = async () => {
          try {
            await signInAnonymously(auth);
          } catch (e) { console.error("Firebase Auth Error", e); }
        };
        initAuth();
        return onAuthStateChanged(auth, setUser);
      }, []);

      // 2. å³æ™‚è³‡æ–™ç›£è½ (Firestore Real-time Sync)
      useEffect(() => {
        let unsubscribe = () => {};
        if (isCloudEnabled && user) {
          setSyncStatus('syncing');
          // è¦å‰‡è·¯å¾‘ï¼š/artifacts/{appId}/public/data/{collectionName}
          const tripRef = doc(db, 'artifacts', appId, 'public', 'data', `day${activeDay}`);
          
          unsubscribe = onSnapshot(tripRef, (docSnap) => {
            if (docSnap.exists()) {
              setLocations(docSnap.data().items || []);
            } else {
              setLocations([]);
            }
            setSyncStatus('success');
          }, (err) => {
            console.error("Firestore Listen Error", err);
            setSyncStatus('local');
          });
        } else {
          const saved = localStorage.getItem(`trip_day${activeDay}`);
          setLocations(saved ? JSON.parse(saved) : []);
        }
        return () => unsubscribe();
      }, [activeDay, user]);

      // 3. å„²å­˜åŠŸèƒ½ (è‡ªå‹•åˆ¤æ–·é›²ç«¯æˆ–æœ¬åœ°)
      const saveLocs = async (newData) => {
        setLocations(newData);
        if (isCloudEnabled && user) {
          setSyncStatus('syncing');
          try {
            const tripRef = doc(db, 'artifacts', appId, 'public', 'data', `day${activeDay}`);
            await setDoc(tripRef, { items: newData, lastUpdated: new Date() });
            setSyncStatus('success');
          } catch (e) {
            console.error("Save Error", e);
            setSyncStatus('local');
          }
        } else {
          localStorage.setItem(`trip_day${activeDay}`, JSON.stringify(newData));
        }
      };

      return (
        <div className="max-w-md mx-auto min-h-screen flex flex-col shadow-2xl bg-stone-50">
          <header className="sticky top-0 z-[60] bg-white/80 backdrop-blur-xl border-b px-4 py-4 flex justify-between items-center shadow-sm">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-indigo-900 rounded-2xl flex items-center justify-center text-white font-black shadow-lg">ç¦</div>
              <div>
                <h1 className="font-black text-sm tracking-tight">FUKUOKA 2026</h1>
                <div className="flex items-center gap-1">
                  <div className={`sync-dot ${syncStatus === 'success' ? 'bg-green-500' : syncStatus === 'syncing' ? 'bg-amber-400 animate-pulse' : 'bg-stone-300'}`}></div>
                  <p className="text-[9px] font-bold text-stone-400 uppercase tracking-widest">{syncStatus === 'success' ? 'é›²ç«¯åŒæ­¥ä¸­' : 'æœ¬æ©Ÿæ¨¡å¼'}</p>
                </div>
              </div>
            </div>
            <div className="flex gap-2">
              <button onClick={() => setIsEditing(!isEditing)} className={`px-4 py-2 rounded-full text-xs font-bold transition-all ${isEditing ? 'bg-indigo-600 text-white shadow-lg' : 'bg-stone-100 text-stone-500'}`}>
                {isEditing ? <Check size={16} /> : <Edit2 size={16} />}
              </button>
            </div>
          </header>

          <main className="flex-1 p-4 overflow-y-auto">
            {activeTab === 'itinerary' ? (
              <>
                <SearchBar onAdd={s => saveLocs([...locations, s])} apiKey={apiKey} />
                
                <div className="flex gap-2 mb-6 overflow-x-auto no-scrollbar py-2">
                  {[1, 2, 3, 4].map(d => (
                    <button key={d} onClick={() => setActiveDay(d)} className={`flex-shrink-0 px-6 py-3 rounded-2xl text-xs font-bold transition-all ${activeDay === d ? 'bg-indigo-900 text-white shadow-xl scale-105' : 'bg-white text-stone-400 border border-stone-100 shadow-sm'}`}>
                      {getTripDate(d)}
                    </button>
                  ))}
                </div>

                <div className="flex justify-between items-center mb-4">
                  <h2 className="font-black text-xl text-stone-800">Day {activeDay} è¡Œç¨‹è¡¨</h2>
                  <button onClick={() => setViewMode(viewMode === 'list' ? 'map' : 'list')} className="p-2 bg-white rounded-xl shadow-sm border text-stone-400 active:scale-95 transition-transform">
                    {viewMode === 'list' ? <MapIcon size={20}/> : <List size={20}/>}
                  </button>
                </div>

                {viewMode === 'list' ? (
                  <div className="space-y-3">
                    {locations.length === 0 && <div className="text-center py-20 text-stone-300 font-medium">å°šæœªå®‰æ’è¡Œç¨‹ï¼Œè«‹æœå°‹æ–°å¢</div>}
                    {locations.map((item, i) => (
                      <ItineraryCard key={item.id} item={item} index={i} total={locations.length} isEditing={isEditing} onRequestDelete={idx => { const c = [...locations]; c.splice(idx, 1); saveLocs(c); }} onUpdate={(idx, f, v) => { const c = [...locations]; c[idx][f] = v; saveLocs(c); }} onMove={(idx, dir) => { const c = [...locations]; const t = idx + dir; if (t < 0 || t >= c.length) return; [c[idx], c[t]] = [c[t], c[idx]]; saveLocs(c); }} />
                    ))}
                  </div>
                ) : (
                  <div className="rounded-3xl overflow-hidden shadow-2xl border-4 border-white">
                    <GoogleMapView locations={locations} apiKey={apiKey} />
                  </div>
                )}
              </>
            ) : (
              <InfoTab apiKey={apiKey} setApiKey={setApiKey} isCloud={isCloudEnabled} />
            )}
          </main>

          <nav className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t px-8 py-4 flex justify-between items-center z-[100] safe-area-bottom shadow-2xl">
            <button onClick={() => setActiveTab('itinerary')} className={`flex flex-col items-center gap-1 ${activeTab === 'itinerary' ? 'text-indigo-900' : 'text-stone-300'}`}><MapPin size={26} strokeWidth={2.5}/><span className="text-[10px] font-black">è¡Œç¨‹</span></button>
            <button onClick={() => alert('è¨˜å¸³åŠŸèƒ½å»ºè­°ç¶­æŒæœ¬æ©Ÿæ¨¡å¼ï¼Œæˆ–å¾…ä¸‹éšæ®µæ›´æ–°')} className="text-stone-300 flex flex-col items-center gap-1"><Wallet size={26} /><span className="text-[10px] font-black">è¨˜å¸³</span></button>
            <button onClick={() => setActiveTab('info')} className={`flex flex-col items-center gap-1 ${activeTab === 'info' ? 'text-indigo-900' : 'text-stone-300'}`}><Key size={26} /><span className="text-[10px] font-black">è¨­å®š</span></button>
          </nav>
        </div>
      );
    }

    // --- æœå°‹å…ƒä»¶ (æ•´åˆ New Places API) ---
    function SearchBar({ onAdd, apiKey }) {
      const [query, setQuery] = useState('');
      const [results, setResults] = useState([]);
      const [loading, setLoading] = useState(false);
      const [isReady, setIsReady] = useState(false);

      useEffect(() => {
        if (!apiKey) return;
        loadGoogleMapsScript(apiKey).then(() => setIsReady(true)).catch(console.error);
      }, [apiKey]);

      const handleSearch = async () => {
        if (!query || !isReady) return;
        setLoading(true);
        try {
          const { Place } = await google.maps.importLibrary("places");
          const { places } = await Place.searchByText({
            textQuery: query,
            fields: ['displayName', 'location', 'formattedAddress', 'id', 'rating'],
            locationBias: { lat: 33.59, lng: 130.42 }
          });
          setResults(places || []);
        } catch (e) { console.error(e); } finally { setLoading(false); }
      };

      return (
        <div className="relative mb-4">
          <div className="flex gap-2">
            <input className="flex-1 p-4 bg-white border border-stone-200 rounded-2xl shadow-sm text-sm outline-none focus:ring-2 focus:ring-indigo-500/10" placeholder={isReady ? "æƒ³å»å“ªè£¡ï¼Ÿ" : "é€£ç·šåœ°åœ–ä¸­..."} value={query} onChange={e => setQuery(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSearch()} />
            <button onClick={handleSearch} className="w-14 bg-indigo-900 text-white rounded-2xl flex items-center justify-center shadow-lg active:scale-95 transition-transform">
              {loading ? <Loader2 size={20} className="animate-spin" /> : <Search size={24} />}
            </button>
          </div>
          {results.length > 0 && (
            <div className="absolute top-full left-0 right-0 mt-2 bg-white rounded-2xl shadow-2xl border z-[70] max-h-60 overflow-y-auto divide-y">
              {results.map((p) => (
                <button key={p.id} onClick={() => { onAdd({ id: Date.now(), type: 'spot', name: p.displayName, lat: p.location.lat(), lng: p.location.lng(), desc: p.formattedAddress, placeId: p.id, rating: p.rating, note: '', time: '' }); setQuery(''); setResults([]); }} className="w-full text-left p-4 hover:bg-stone-50">
                  <div className="font-bold text-stone-800 text-sm">{p.displayName}</div>
                  <div className="text-[10px] text-stone-400 truncate">{p.formattedAddress}</div>
                </button>
              ))}
            </div>
          )}
        </div>
      );
    }

    // --- åœ°åœ–å…ƒä»¶ (æ–°ç‰ˆ Advanced Marker) ---
    function GoogleMapView({ locations, apiKey }) {
      const mapRef = useRef(null);
      const mapInstance = useRef(null);
      const markers = useRef([]);

      useEffect(() => {
        if (!apiKey || !mapRef.current) return;
        const init = async () => {
          await loadGoogleMapsScript(apiKey);
          const { Map } = await google.maps.importLibrary("maps");
          const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");

          if (!mapInstance.current) {
            mapInstance.current = new Map(mapRef.current, { center: { lat: 33.59, lng: 130.42 }, zoom: 13, mapId: 'DEMO_MAP_ID', disableDefaultUI: true, zoomControl: true, gestureHandling: 'greedy' });
          }

          markers.current.forEach(m => m.map = null);
          markers.current = [];
          const bounds = new google.maps.LatLngBounds();
          locations.forEach((loc, i) => {
            const pin = new PinElement({ glyph: (i+1).toString(), background: '#4f46e5', borderColor: '#312e81', glyphColor: 'white' });
            const marker = new AdvancedMarkerElement({ map: mapInstance.current, position: { lat: loc.lat, lng: loc.lng }, content: pin.element, title: loc.name });
            markers.current.push(marker);
            bounds.extend({ lat: loc.lat, lng: loc.lng });
          });
          if (locations.length > 0) mapInstance.current.fitBounds(bounds);
        };
        init();
      }, [locations, apiKey]);

      return <div ref={mapRef} className="w-full h-[50vh] bg-stone-100" />;
    }

    // --- è¡Œç¨‹å¡ç‰‡ ---
    function ItineraryCard({ item, index, total, isEditing, onRequestDelete, onUpdate, onMove }) {
      const getIcon = (type) => {
        switch(type) {
          case 'food': return <Utensils size={18} className="text-orange-500"/>;
          case 'shop': return <ShoppingBag size={18} className="text-pink-500"/>;
          case 'transport': return <Train size={18} className="text-emerald-500"/>;
          default: return <Camera size={18} className="text-indigo-500"/>;
        }
      };
      return (
        <div className={`bg-white rounded-2xl p-4 shadow-sm border border-stone-100 relative transition-all ${isEditing ? 'border-l-4 border-l-indigo-500' : ''}`}>
          <div className="flex items-start gap-3">
            {isEditing ? (
              <div className="flex flex-col gap-1">
                <button onClick={() => onMove(index, -1)} disabled={index===0} className="p-1 bg-stone-100 rounded text-stone-400 disabled:opacity-20"><ArrowUp size={16}/></button>
                <button onClick={() => onMove(index, 1)} disabled={index===total-1} className="p-1 bg-stone-100 rounded text-stone-400 disabled:opacity-20"><ArrowDown size={16}/></button>
              </div>
            ) : (
              <div className="flex flex-col items-center gap-1 mt-1 shrink-0">
                <div className="w-6 h-6 bg-indigo-900 text-white rounded-full flex items-center justify-center text-[10px] font-black shadow-sm">{index+1}</div>
                {item.time && <div className="text-[9px] font-mono font-bold bg-stone-50 px-1 rounded border">{item.time}</div>}
              </div>
            )}
            <div className="mt-1 p-2 bg-stone-50 rounded-full">{getIcon(item.type)}</div>
            <div className="flex-1 min-w-0">
              <div className="flex justify-between items-start mb-1">
                <div className="flex-1">
                  <h3 className="font-bold text-stone-800 truncate leading-tight">{item.name}</h3>
                  {isEditing && <input type="time" className="mt-1 bg-stone-100 text-[10px] px-1 rounded border" value={item.time||''} onChange={e=>onUpdate(index,'time',e.target.value)}/>}
                  <p className="text-[10px] text-stone-400 truncate mt-0.5">{item.desc}</p>
                </div>
                {!isEditing && <a href={`https://www.google.com/maps/search/?api=1&query=${item.lat},${item.lng}`} target="_blank" className="p-2 text-blue-600 bg-blue-50 rounded-full active:scale-90"><Navigation size={16}/></a>}
                {isEditing && <button onClick={()=>onRequestDelete(index)} className="p-2 text-red-500 bg-red-50 rounded-full active:scale-90"><Trash2 size={16}/></button>}
              </div>
              <input className="w-full text-xs text-stone-500 bg-stone-50/50 p-2 rounded-xl border border-transparent focus:border-indigo-100 focus:bg-white outline-none" placeholder="è¼¸å…¥å‚™è¨»..." value={item.note||''} onChange={e=>onUpdate(index,'note',e.target.value)} />
            </div>
          </div>
        </div>
      );
    }

    // --- è¨­å®šé é¢ ---
    function InfoTab({ apiKey, setApiKey, isCloud }) {
      return (
        <div className="space-y-4 animate-in slide-in-from-bottom-4">
          <div className="bg-indigo-50 p-6 rounded-3xl border border-indigo-100">
            <h3 className="font-bold text-indigo-900 mb-2 flex items-center gap-2"><Key size={18}/> Google Maps Key</h3>
            <input type="text" value={apiKey} onChange={e => {setApiKey(e.target.value); localStorage.setItem('google_maps_key', e.target.value);}} className="w-full p-3 bg-white border rounded-2xl font-mono text-xs" placeholder="Paste API Key" />
            <button onClick={() => window.location.reload()} className="mt-3 w-full py-3 bg-indigo-600 text-white rounded-2xl font-bold text-sm shadow-md">å¥—ç”¨ä¸¦é‡æ•´</button>
          </div>
          <div className="bg-white p-6 rounded-3xl border shadow-sm flex items-start gap-4">
            <div className={`p-3 rounded-2xl ${isCloud ? 'bg-green-50 text-green-600' : 'bg-stone-50 text-stone-400'}`}>
              {isCloud ? <Cloud size={24}/> : <CloudOff size={24}/>}
            </div>
            <div>
              <h3 className="font-bold text-stone-800 text-sm">é›²ç«¯åŒæ­¥ç‹€æ…‹</h3>
              <p className="text-xs text-stone-500 mt-1 leading-relaxed">
                {isCloud ? "âœ… å·²æˆåŠŸé€£ç·šè‡³ Firebaseã€‚æ‚¨åœ¨æ‰‹æ©Ÿä¸Šæ‰€åšçš„ä»»ä½•ä¿®æ”¹ï¼Œæ‚¨çš„æ—…ä¼´æ‰“é–‹æ­¤ç¶²å€æ™‚éƒ½èƒ½åŒæ­¥çœ‹åˆ°ã€‚" : "âš ï¸ å°šæœªåµæ¸¬åˆ° Firebase Configã€‚ç›®å‰è¡Œç¨‹åƒ…æœƒå„²å­˜åœ¨é€™å°æ‰‹æ©Ÿä¸­ã€‚"}
              </p>
            </div>
          </div>
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>